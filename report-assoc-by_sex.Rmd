---
title: "`r paste('Association test -', stringr::str_to_title(sex))`"
author: "Mun-Gwan Hong"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: 
      collapse : false
    toc_depth: 3
    code_folding: hide
    number_sections: true
    css: styles.css
bibliography: citations_in_report.bib
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding= encoding, output_dir= "../reports") })
---

```{r, echo=FALSE, include=FALSE}
# the defaults, when no passover
if(!exists("sex")) sex <- "female"
if(!exists("panels")) panels <- c("Inflammation", "Neurology")

## Chunk hooks
knitr::knit_hooks$set(
  optipng = knitr::hook_optipng   # Ready to activate optipng (Optimize PNG)
)
## Set default chunk options
knitr::opts_chunk$set(
	# dev = c('pdf'), fig.path = '../results/figures/', # export figures to pdf files
  results = "asis",   # for HTML
  message = FALSE,    # no message from the code
  warning = FALSE,    # no warning from the code
	cache.path = "../cache/",   # cache the results from heavy analyses
  cache.extra = c(panels, sex),
  fig.width  = 8,
  fig.height = 6,
	eval.after = "fig.cap",    # to add fig. caption within the chunk
  optipng = '-o1', # '-o7 -zc9 -zm8 -zs0', # Optimize 'png' plots
	purl = FALSE      # because most of the code are not to be extracted
)
options(knitr.kable.NA = '')  # NA is shown as ''
```

```{r, echo=FALSE, include=FALSE, purl=TRUE}
## Pre-loaded packages
# Please note that some functions are called directly from the package using
# double-colon '::' or triple-colon ':::' to make the source clearer.
library(tidyverse)
library(kableExtra)
library(foreach)  # %dopar%, foreach
```

```{r, purl=TRUE}
## File names
fn <- list(
  lib = list(
    general = "utils.R",
    assoc = "anal-assoc_protein-utils.R"
  ),
	i = list(                               # input
    olk02 = "../data/s1-olink_proteomic.v02.RData",
    c02 = "../data/s1-clinical.v02.RData",
    perm_t = "../cache/lm_resample_t.RData"
	),
  o = list(         # intermediate results
    res = paste0("../cache/assoc-", sex, "-", 
                 paste(panels, collapse = ","), ".RData")
  )
)
# Brief check if all files exist
stopifnot(all(file.exists(unlist(fn$lib), unlist(fn$i), dirname(unlist(fn$o)))))

source(fn$lib$general)  # Words, ...
source(fn$lib$assoc)  # functions for association tests

# Load proteomic data ver.02
load(fn$i$olk02)
# Load clinical information ver.02
load(fn$i$c02)


####### < FEMALES / MALES ONLY > #######
qns <- qns %>% 
  filter(Sex == str_to_title(sex))
olink <- olink %>% 
  filter(SampleID %in% qns$SampleID)


####### < SELECTED PANELS > #######
olink <- olink %>% 
  filter(Panel %in% panels)



# Load T statistics collected during resampling for max T test
if(!exists("resample_t_res")) load(fn$i$perm_t)
# number of permutation
N_PERMUTATION <- ncol(resample_t_res[[sex]][[1]][[1]]) - 1

# combine `olink` and `qns` for association tests
olink_qns <- left_join(olink, qns, by = "SampleID")

# proteins
proteins <- distinct(olink_qns, OlinkID, Protein = Assay, Panel)
n_prots <- n_distinct(proteins$OlinkID)

# Initialize to store association test results
assoc_res <- list()
```

All analyses below were limited to **`r sex`** participants and Olink **`r panels`** panel(s).


## Background

### Dimension

The numbers of samples and proteins to analyze are as below.

```{r}
olink_qns %>% 
  group_by(Panel) %>% 
  summarise(
    Samples = n_distinct(SampleID),
    Proteins = n_distinct(OlinkID)
  ) %>% 
  kbl() %>% 
  kable_styling(full_width = FALSE)
```

### Prior observation about on relevant variables

#### Body-mass-index (BMI)

BMI is **missing** for a relatively large proportion of participants
(N = `r sum(is.na(qns$BMI))`, 
`r round(sum(is.na(qns$BMI)) / dim(qns)[1L] * 100, 1)`%).

#### Smoking

```{r}
# confirm the statement below
stopifnot(all(is.na(qns$BMI[is.na(qns$Smoking)])))
```

Smoking status is **missing** for a relatively large proportion of participants
(N = `r sum(is.na(qns$Smoking))`, 
`r round(sum(is.na(qns$Smoking)) / dim(qns)[1L] * 100, 1)`%).
For all of them, BMI was also missing.

#### Hearing problem

The hearing problem variable (`TSCHQ_26`) is **missing** for a relatively large proportion of participants
(N = `r sum(is.na(qns$TSCHQ_26))`, 
`r round(sum(is.na(qns$TSCHQ_26)) / dim(qns)[1L] * 100, 1)`%). 
Among them, only `r sum(is.na(qns$TSCHQ_26) & is.na(qns$Smoking))` participants' smoking status was also missing. 

```{r, purl=TRUE}
# Tibble of covariates and association test functions
cvar_test <- tribble(
  ~rhs,                 ~test,
  "Age",                "lm",
  "BMI",                "lm",
  "Smoking",            "aov",
  "`Sample Lab`",       "aov",
  "Age + `Sample Lab`", "aov",
  "`Collection Date`",  "lm",
  "PlateID",            "aov"
) %>% 
  mutate(
    # one line version of those tests
    f_1line = map(test, ~ get(paste0(.x, "_out_1line"))),
    # For which variable test will be performed
    test_for = map2_chr(rhs, test, ~ {
      v <- all.vars(formula(paste("X ~", .x)))
      case_when(
        .y == "lm" ~ v[2],
        .y == "aov" ~ v[length(v)],
        TRUE ~ NA_character_
      )
    })
  )
# Association tests
assoc_res$covariates <- lapply(
  1:nrow(cvar_test),
  function(ii) {
    f <- formula(paste("NPX ~", cvar_test$rhs[ii]))
    olink_qns %>% 
      select(OlinkID, Assay, all_of(all.vars(f))) %>% # due to too wide table
      nest(data = -c(OlinkID, Assay)) %>% 
      add_column(map_dfr(.$data, ~ cvar_test$f_1line[[ii]](f, .x))) %>% 
      mutate(adj.P = p.adjust(Pval, method= 'bonferroni')) %>% 
      select(-data) %>% 
      arrange(Pval)
  }
) %>% 
  `names<-`(cvar_test$rhs)
```

### Covariates

`r Words(n_distinct(cvar_test$test_for))` potential covariates were tested for the association with individual protein profiles.
Several proteins were found correlated with some of those covariates.
Especially, quite a large number of proteins were significantly associated with **age, sex, BMI and sample lab**. 
So, those variables were included in most of following analyses as covariates.

Summary table is shown below.
Results in more detail follow. 

```{r}
# summary table of the association between individual proteins and covariates
assoc_res$covariates %>% 
  map_dfr(., ~ select(.x, Assay, Model, Term, adj.P)) %>% 
  group_by(Term, Model) %>% 
  summarise(
    prots = list(Assay[adj.P < 0.05]),
    N = map_int(prots, length),
    Propn. = sprintf("%4.1f%%", N / n_prots * 100),
    Proteins = map_chr(prots, ~ str_trunc(paste(.x, collapse = ", "), 20)),
    .groups = "drop"
  ) %>% 
  select(-prots) %>%
  rename(`Nr. or assoc.\nproteins` = N) %>% 
  mutate(
    # show in the order as `cvar_test`
    Term = fct_relevel(Term, unique(cvar_test$test_for)),
    Model = str_remove_all(Model, "`")
  ) %>% 
  arrange(Term) %>% 
  kbl(align = "llrrl") %>% 
  kable_styling()
```

#### Age

```{r}
# increasing/decreasing proteins as age advances
hits <- filter(assoc_res$covariates$Age, adj.P < 0.05) %>%
  split(., recode(sign(.$Estimate), "1" = "inc", "-1" = "dec"))
hits$n_all <- nrow(bind_rows(hits))
```

`r Words(hits$n_all)` proteins were found correlated with age by linear regression.
Among them, the profiles of `r nrow(hits$inc)` proteins (`r round(nrow(hits$inc) / hits$n_all * 100, 1)`%) increased as age advances, 

#### BMI

```{r}
# increasing/decreasing proteins as BMI
hits <- filter(assoc_res$covariates$BMI, adj.P < 0.05) %>%
  split(., recode(sign(.$Estimate), "1" = "inc", "-1" = "dec"))
hits$n_all <- nrow(bind_rows(hits))
```

`r Words(hits$n_all)` proteins were found correlated with BMI by linear regression.
Among them, the profiles of `r nrow(hits$inc)` proteins (`r round(nrow(hits$inc) / hits$n_all * 100, 1)`%) increased as BMI, 

#### Smoking (`A7`)

```{r}
hits <- filter(assoc_res$covariates$Smoking, adj.P < 0.05)
```

`r Words(nrow(hits))` proteins were found correlated with smoking status by ANOVA. 

#### Sample Lab

```{r}
hits <- map(
  c("`Sample Lab`", "Age + `Sample Lab`") %>% 
    `names<-`(., str_remove_all(., "`")),   # inline access
  ~ filter(assoc_res$covariates[[.x]], adj.P < 0.05)
)
hits$intx <- hits[["Age + Sample Lab"]] %>% 
  filter(Assay %in% hits[["Sample Lab"]]$Assay)
```

`r Words(nrow(hits[["Sample Lab"]]))` proteins were found different across sample labs by ANOVA. 
In order to take into account dissimilar age distribution between sample labs, the association was also tested after adjusting for age.
`r Words(nrow(hits[["Age + Sample Lab"]]))` proteins were found after the adjustment,
which were `r knitr::combine_words(hits[["Age + Sample Lab"]]$Assay, before = "\x60")`.
Among them, `r nrow(hits$intx)` proteins were in common.

#### Collection Date (age of sample)

```{r}
# increasing/decreasing proteins as the collection date
hits <- filter(assoc_res$covariates[["`Collection Date`"]], adj.P < 0.05)
```

`r Words(nrow(hits))` protein was found correlated with sample collection date or the age of samples by linear regression.

#### Assay Plate

```{r}
hits <- filter(assoc_res$covariates$PlateID, adj.P < 0.05) 
```

`r Words(nrow(hits))` protein was associated with assay plate. 

------------------------

## Association test for individual proteins

### Notes for the result tables in following sections

- The 'p value' is the nominal p value without any multiple correction.

- The **'Adj.P by perm.'** is the adjusted P value by $`r N_PERMUTATION`$ permutation 
using Westfall and Young's max-T method ([Westfall and Young, 1993](https://www.google.com/books?hl=en&lr=&id=nuQXORVGI1QC&oi=fnd&pg=PR11&dq=resampling-based+multiple+testing+examples+and+methods+for+p-value+adjustment+pdf&ots=XngUGMa2LO&sig=Vr87y-1gzC_Glhz3sB6N9R95MU0)). 
The resampling-based procedure can take into account correlation structure in data.
It is often considered as a good method to handle multiple testing correction, but it is computationally heavy. 

- The 'q value' was computed using 'qvalue' (v `r packageVersion("qvalue")`) R package ([Ref](https://projecteuclid.org/euclid.aos/1074290335)) to adjust the p values for the number of hypothesis tests. 

- Those **multiple testing corrections** (given as 'Adj.P by perm.' and 'q value') were conducted **per table**. 
In other words, it was for all the tests of **a selected model only**. 
Those corrections were not applied for controlling the family-wide error rate or positive false discovery rate of overall tests in this report. 
As an example, the q values from the models for Tinnitus status including age and smoking as covariate didn't take into account the tests without any adjustment nor the tests with hearing problem. 


### Assoc. with tinnitus status

#### Notes

##### Data source

- The tinnitus status was obtained from LifeGene questionnaire table, in which it was labeled as `Intro_3`.

##### Statistical models for association tests

- Linear regression model for the association between one protein and Tinnitus status, including a varying set of covariates for adjustment of the effects of them. 
The adjustment factors are listed for each model. 

- `lm(Protein ~ (tinnitus status) + covariate1 + covariate2 + ...)`

##### Effect size shown in result tables

- The effect size, labeled as $\Delta$'(Yes - No)' in the following tables, is the difference between tinnitus cases and controls of estimated protein values after adjustment for selected covariates. 
Positive value indicates the estimated value was higher in cases than controls.
Please note that absolute magnitudes are not comparable between proteins, because the NPX values from Olink assays were given in arbitrary units.

#### Main results

```{r}
#' Show the results of tinnitus association tests
#'
#' @param out_df the data frame of the output from `lm_prot_padj_by_max_t`
#' @param proteins the table of protein name and OlinkID
#' @param n,caption check \code{\link{show_res_p}}
show_delta_P_perm <- function(
  out_df, proteins, n = 5, caption = paste("Top", n, "proteins")
) {
  out_df %>% 
    mutate(
      qval = tryCatch(
        qvalue::qvalue(out_df$Pval),
        # ERROR: maximum p-value is smaller than lambda range.
        error = function(cond) qvalue::qvalue_truncp(out_df$Pval)
      )$qvalues
    ) %>% 
    left_join(proteins, by = "OlinkID") %>% 
    show_res_p(
      Protein, 
      "$\\Delta$(Yes - No)" = Estimate, 
      "Adj.P by perm." = P_perm, 
      "_q_ value" = qval,
      n = n,
      caption = caption
    )
}
# No missing in those variables
stopifnot(
  all(!is.na(qns$Age)),
  all(!is.na(qns$Tinnitus)),
  all(!is.na(qns$`Sample Lab`))
)
```

```{r, purl=TRUE}
assoc_res$tinnitus <- map(
  resample_t_res[[sex]],
  ~ lm_prot_padj_by_max_t(.x, olink, qns, pos = 1L)
)
```

##### **Without** any adjustment

```{r}
out_df <- assoc_res$tinnitus[["Tinnitus"]]
```

* `r Words(sum(out_df$P_perm < 0.05))` protein
was significantly associated with tinnitus (adjusted P by permutation < 0.05). 

```{r}
show_delta_P_perm(out_df, proteins)
```

##### Covariates included : **age**

```{r}
out_df <- assoc_res$tinnitus[["Tinnitus + Age"]]
```

* `r Words(sum(out_df$P_perm < 0.05))` protein
was significantly associated with tinnitus (adjusted P by permutation < 0.05). 

```{r}
show_delta_P_perm(out_df, proteins)
```

##### Covariates included : age and **sample lab**

```{r}
out_df <- assoc_res$tinnitus[["Tinnitus + Age + `Sample Lab`"]]
```

* `r Words(sum(out_df$P_perm < 0.05))` protein
was significantly associated with tinnitus (adjusted P by permutation < 0.05). 

```{r}
show_delta_P_perm(out_df, proteins)
```

##### Covariates included : age and **smoking**

```{r}
out_df <- assoc_res$tinnitus[["Tinnitus + Age + Smoking"]]
```

* `r Words(sum(out_df$P_perm < 0.05))` protein
was significantly associated with tinnitus (adjusted P by permutation < 0.05). 
* Please note that the number of samples included in this analysis was substantially lower,
because smoking status of `r round(sum(is.na(qns$Smoking)) / nrow(qns) * 100, 1)`% of samples is missing.

```{r}
show_delta_P_perm(out_df, proteins)
```

##### Covariates included : age, **sample lab**, and **smoking**

```{r}
out_df <- assoc_res$tinnitus[["Tinnitus + Age + `Sample Lab` + Smoking"]]
```

* `r Words(sum(out_df$P_perm < 0.05))` protein
was significantly associated with tinnitus (adjusted P by permutation < 0.05). 
* Please note that the number of samples was lower due to missing smoking status.

```{r}
show_delta_P_perm(out_df, proteins)
```

##### Covariates included : **hearing problem** (`TSCHQ_26`) as well as age and smoking

```{r}
out_df <- assoc_res$tinnitus[["Tinnitus + Age + Smoking + TSCHQ_26"]]
```

* `r Words(sum(out_df$P_perm < 0.05))` protein
was significantly associated with tinnitus (adjusted P by permutation < 0.05). 

```{r}
show_delta_P_perm(out_df, proteins)
```

##### Covariates included : age, sample lab, smoking, and hearing problem

```{r}
out_df <- assoc_res$tinnitus[["Tinnitus + Age + `Sample Lab` + Smoking + TSCHQ_26"]]
```

* Due to missing smoking and/or hearing problem status, only `r nrow(drop_na(qns, Smoking, TSCHQ_26))` samples were included in this analysis.
* `r Words(sum(out_df$P_perm < 0.05))` protein
was significantly associated with tinnitus (adjusted P by permutation < 0.05). 

```{r}
show_delta_P_perm(out_df, proteins)
```

#### Additional results with adjustment for stress variables

```{r}
# stress related variables
stress <- tribble(
  ~lab,                 ~desc,
  "PSQ Total score",    "Stress",
  "HADS_A Total score", "Anxiety",
  "HADS_D Total score", "Depression",
  "HQ Total score",     "Hyperacusis",
  "A15_4",              "Temporomandibular joint pain",
  "A15_1",              "headache"
) %>% 
  mutate(with_q = paste0("`", lab, "`"))
```

- Stress related variables : `r knitr::combine_words(stress$with_q)`.

- Tests for association between tinnitus and individual proteins

- Due to missing information, `r nrow(drop_na(qns, Smoking, all_of(stress$lab)))` samples were analyzed here.

##### Individual stress related variables

* Covariates included : **individual stress related variables** as well as age, smoking, and Sample Lab

- `lm(Protein ~ (tinnitus status) + age + smoking + sample lab + "a stress")`

```{r}
for(ii in 1:nrow(stress)) {
  rhs <- paste("Tinnitus + Age + Smoking + `Sample Lab` +", stress$with_q[ii])
  print(show_delta_P_perm(
    assoc_res$tinnitus[[rhs]], proteins,
    caption = paste0(stress$desc[ii], " (", stress$lab[ii], ")")
  ))
}
```

##### **All `r words(nrow(stress))` stress related variables**

* Covariates included : **all `r nrow(stress)` stress related variables** plus age, smoking, and Sample Lab

- `lm(Protein ~ (tinnitus status) + age + smoking + sample lab + stress 1 + stress 2 + ... + stress i)`

```{r}
rhs <- paste(stress$with_q, collapse = " + ") %>% 
  paste("Tinnitus + Age + Smoking + `Sample Lab` +", .)
print(show_delta_P_perm(
  assoc_res$tinnitus[[rhs]], proteins,
  caption = paste("All", nrow(stress), "stress related variables")
))
```

----------------------------

### Assoc. with stress

#### Notes

##### Data source

- Stress related variables

```{r}
stress %>% 
  select("Variable ID" = "lab", "Description" = "desc") %>% 
  kbl() %>% 
  kable_styling(full_width = FALSE)
```

- Due to missing information, `r nrow(drop_na(qns, Smoking, all_of(stress$lab)))` samples were analyzed here.

##### Statistical models for association tests

- Linear regression model or ANOVA for the association between one protein and **individual stress related variables**, 
including age, smoking, sample lab, and tinnitus status.

- `lm(Protein ~ (a stress variable) + age + smoking + sample lab + tinnitus status)`

```{r, purl=TRUE}
stress_rhs <- map_chr(
  1:nrow(stress),
  ~ paste("Tinnitus + Age + Smoking + `Sample Lab` +", stress$with_q[ii])
)
# names(resample_t_res[[sex]][stress_rhs[1]][[1]])
# [1] "TinnitusYes, always"   "Age"                   "SmokingCurrent smoker"
# [4] "SmokingEx-smoker"      "`Sample Lab`Stureplan" "`Sample Lab`Umeå"     
# [7] "`PSQ Total score`" 
assoc_res$stress <- map(
  resample_t_res[[sex]][stress_rhs],
  ~ lm_prot_padj_by_max_t(.x, olink, qns, pos = 7L)
)
```

##### Effect size shown in result tables

- The effect size, labeled as 'Estimate' in the following tables, is the change by one unit increment of the scores (e.g. from 0 to 1) or $\Delta$(`No` - `Yes`), the difference between `No` and `Yes`.
Please note that absolute magnitudes are not comparable between proteins, because the NPX values from Olink assays were given in arbitrary units.

#### Results

```{r}
tmp <- map(assoc_res$stress, ~ (.x$P_perm < 0.05))
```

* `r Words(sum(unlist(tmp)))` protein was significantly associated with one of stress variables (adjusted P by permutation < 0.05). 

```{r, fig.width=5, fig.height=4}
for(ii in 1:nrow(stress)) {
  p <- assoc_res$stress[[ii]] %>% 
    left_join(proteins, by = "OlinkID") %>% 
    show_res_p(
      Protein, Estimate, "Adj.P by perm." = P_perm,
      caption = paste0(stress$desc[ii], " (", stress$lab[ii], ")")
    )
  print(p)
} 

for(ii in 1:nrow(stress)) {
  if(any(tmp[[ii]])) {
    hits <- assoc_res$stress[[ii]]$OlinkID[tmp[[ii]]]
    p <- olink_qns %>% 
      filter(OlinkID %in% hits) %>%
      drop_na(NPX, Assay, all_of(stress$lab[ii])) %>% 
      ggplot() +
      aes_string(x = stress$with_q[ii], y = "NPX") +
      facet_wrap(~ Assay) +
      ggtitle(paste0(stress$desc[ii], " (", stress$lab[ii], ")"))
    if(n_distinct(olink_qns[[stress$lab[ii]]]) == 2) {
      print(p + geom_boxplot() + add_n())
    } else {
      print(p + geom_point())
    }
  }
}
```

----------------------------

### Assoc. with hearing problem (`TSCHQ_26`)

#### Notes

##### Statistical models for association tests

- Linear regression model for the association between one protein and **hearing problem (Yes vs. No)**, 
including age, smoking, and sample lab.

- `lm(Protein ~ (hearing problem) + age + smoking + sample lab`

```{r, purl=TRUE}
# Association tests
assoc_res$hearing_problem <- olink_qns %>%
  nest(data = -c(OlinkID, Assay)) %>%
  add_column(map_dfr(.$data, ~ lm_out_1line(
    # to avoid too large cache
    NPX ~ TSCHQ_26 + Age + Smoking + `Sample Lab`, .x
  ))) %>%
  select(-data) %>% 
  mutate(qval = qvalue::qvalue(Pval)$qvalues)
```

#### Results

* `r Words(sum(assoc_res$hearing_problem$qval < 0.05))` protein was significantly associated with hearing problem (_q_ value < 0.05).

```{r}
assoc_res$hearing_problem %>% 
  show_res_p(Protein = Assay, "$\\Delta$(No - Yes)" = Estimate, "q value" = qval)
```

----------------------------

### Assoc. with tinnitus subtypes (`TSCHQ_??`)

```{r}
# Find sub-type variables 
tinnitus_subtypes <- list(
  cat = c("TSCHQ_5", "TSCHQ_7", "TSCHQ_8", "TSCHQ_9", "TSCHQ_15", "TSCHQ_18", "TSCHQ_22", "TSCHQ_24", "TSCHQ_27"),
  qty = c("TSCHQ_12", "TSCHQ_16", "TSCHQ_17")
)
```

#### Categorical variables

- `r Words(length(tinnitus_subtypes$cat))` categorical variables were tested (
`r knitr::combine_words(tinnitus_subtypes$cat, before = '\x60')`).

##### Statistical models for association tests

- ANOVA for the association between one protein and **individual sub-type variables**, 
including age, smoking, and sample lab.

- `aov(Protein ~ age + smoking + sample lab + (a subtype variable))`

- Please note the number of samples analyzed here was substantially lower, due to missing data of many samples.

##### Homoscedasticity assumption of ANOVA

Because it is known that ANOVA is sensitive to **homoscedasticity** assumption (homogeneity of variance),
_p_ values from Bartlett's test were shown in the result tables. 
When the _p_ value is significant, the association detected by ANOVA was shown significant possibly by heteroscedasticity rather than real difference in mean. 

```{r, purl=TRUE}
# Association tests
assoc_res$subtype$cat <- sapply(
  tinnitus_subtypes$cat,
  function(ii) {
    f <- formula(paste("NPX ~ Age + Smoking + `Sample Lab` +", ii))
    f_b <- formula(paste("NPX ~", ii))  # formula for Bartlett test
    olink_qns %>%
      select(OlinkID, Assay, all_of(all.vars(f))) %>% # due to too wide table
      nest(data = -c(OlinkID, Assay)) %>%
      add_column(map_dfr(.$data, ~ aov_out_1line(f, .x))) %>%
      mutate(
        `Bartlett P` = map_dbl(
          data, ~ tryCatch(bartlett.test(f_b, .x)$p.value,
                           error = function(cond) NA_real_) # at least 2
        )
      ) %>% 
      select(-data) %>% 
      mutate(qval = qvalue::qvalue(Pval)$qvalues)
  },
  simplify = FALSE
)
```

##### Results

```{r}
is_hit <- map(assoc_res$subtype$cat, ~ {.x$qval < 0.05})
```

* `r Words(sum(unlist(is_hit)))` proteins were significantly associated with one of those categorical sub-type variables (_q_ value < 0.05).

```{r}
for(ii in tinnitus_subtypes$cat) {
  if(any(is_hit[[ii]])) {
    qn <- paste(ii, ":", codes$Label[codes$Variable == ii])
    
    assoc_res$subtype$cat[[ii]] %>% 
      filter(qval < 0.05) %>% 
      show_res_p(Protein = Assay, "q value" = qval, 
                 caption = qn, n = Inf, after_p = "Bartlett P") %>% 
      print()

    hits <- assoc_res$subtype$cat[[ii]]$OlinkID[is_hit[[ii]]]
    p <- olink_qns %>% 
      filter(OlinkID %in% hits) %>%
      drop_na(NPX, Assay, Smoking, all_of(ii)) %>% 
      ggplot() +
      aes_string(x = ii, y = "NPX") +
      facet_wrap(~ Assay, ncol = 2, scales = "free_y") +
      geom_boxplot() +
      add_n() +
      theme(axis.text.x = element_text(angle = 10, margin = margin(t = 10))) +
      ggtitle(qn)
    print(p)
  }
}
```

#### Continuous or two-group variables

- `r Words(length(tinnitus_subtypes$qty))` continuous variables were tested (
`r knitr::combine_words(tinnitus_subtypes$qty, before = '\x60')`).

##### Statistical models for association tests

- Linear regression for the association between one protein and **individual sub-type variables**, 
including age, smoking, and sample lab.

- `lm(Protein ~ (a subtype variable) + age + smoking + sample lab)`

```{r, purl=TRUE}
# Association tests
assoc_res$subtype$qty <- sapply(
  tinnitus_subtypes$qty,
  function(ii) {
    f <- formula(paste("NPX ~", ii, "+ Age + Smoking + `Sample Lab`"))
    olink_qns %>%
      select(OlinkID, Assay, all_of(all.vars(f))) %>% # due to too wide table
      nest(data = -c(OlinkID, Assay)) %>%
      add_column(map_dfr(.$data, ~ lm_out_1line(f, .x))) %>%
      select(-data) %>% 
      mutate(qval = qvalue::qvalue(Pval)$qvalues)
  },
  simplify = FALSE
)
```

##### Results

```{r}
is_hit <- map(assoc_res$subtype$qty, ~ {.x$qval < 0.05})
```

* `r Words(sum(unlist(is_hit)))` protein was significantly associated with one of those continuous sub-type variables (_q_ value < 0.05).

```{r}
for(ii in tinnitus_subtypes$qty) {
  if(any(is_hit[[ii]])) {
    qn <- paste(ii, ":", codes$Label[codes$Variable == ii])
    
    assoc_res$subtype$qty[[ii]] %>% 
      filter(qval < 0.05) %>% 
      show_res_p(Protein = Assay, "Change by 1 in score" = Estimate, 
                 "q value" = qval, caption = qn, n = Inf) %>% 
      print()

    hits <- assoc_res$subtype$qty[[ii]]$OlinkID[is_hit[[ii]]]
    p <- olink_qns %>% 
      filter(OlinkID %in% hits) %>%
      drop_na(NPX, Assay, Smoking, all_of(ii)) %>% 
      ggplot() +
      aes_string(x = ii, y = "NPX") +
      facet_wrap(~ Assay, ncol = 2) +
      geom_point() +
      ggtitle(qn)
    print(p)
  }
}
```

----------------------------

### Tinnitus Handicap Inventory `THI_??`

#### Individual THI scores

##### Data source and statistical models

```{r}
# find THI scores
tinnitus_handi_inv <- Filter(function(x) grepl("^THI_", x), names(qns))
# Confirm every THI score is ordered
stopifnot(all(map_lgl(tinnitus_handi_inv, ~ is.ordered(qns[[.x]]))))
# Confirm the number of included samples is constant
tmp <- drop_na(qns, Smoking)
tmp <- map_int(tinnitus_handi_inv, ~ sum(!is.na(tmp[[.x]])))
stopifnot(all(tmp == tmp[1]))
```

- There were `r length(tinnitus_handi_inv)` tinnitus handicap inventory (THI) variables, `THI_??`.

- Every THI score was coded as ordered categories (e.g. `Yes`, `Sometimes` and `No`).

- Linear regression for the association between one protein and **individual THI scores**, 
including age, smoking, and sample lab.

- `lm(Protein ~ (a THI score) + age + smoking + sample lab)`

- The _p_ values were adjusted for all tested proteins and all `r length(tinnitus_handi_inv)` THI variables.

- Due to missing information, `r nrow(drop_na(qns, Smoking, all_of(tinnitus_handi_inv)))` samples were analyzed here.

```{r, purl=TRUE}
# backend for parallel computing
doParallel::registerDoParallel(cores = parallel::detectCores() - 1)
  
# Association tests
assoc_res$THI_scores <- foreach(
  ii = iterators::iter(tinnitus_handi_inv),
  .inorder = FALSE,
  .packages = c("dplyr", "purrr", "tidyr", "tibble")
) %dopar% {
  olink_qns %>%
    # select(OlinkID, Assay, all_of(all.vars(f))) %>% # due to too wide table
    nest(data = -c(OlinkID, Assay)) %>%
    add_column(map_dfr(.$data, ~ lm_out_1line(
      # to avoid too large cache
      formula(paste("NPX ~", ii, "+ Age + Smoking + `Sample Lab`")), 
      .x
    ))) %>%
    select(-data)
} %>% 
  bind_rows() %>% 
  mutate(qval = qvalue::qvalue(Pval)$qvalues)
```

##### Results

```{r}
is_hit <- assoc_res$THI_scores$qval < 0.05
```

* `r Words(sum(is_hit))` protein was significantly associated with one of those THI scores (_q_ value < 0.05).

```{r, fig.height=4, fig.width=6}
if(any(is_hit)) {
  hits <- assoc_res$THI_scores %>% 
    filter(is_hit) %>% 
    mutate(Term = str_remove(Term, ".L")) %>% 
    arrange(Pval)
  
  hits %>% 
    show_res_p(
      Protein = Assay, Term, "Trend Yes-Sometimes-No" = Estimate,
      "_q_ value" = qval, n = Inf, 
      caption = "THI scores"
    ) %>%
    print()

  for(ii in unique(hits$Term)) {
    p <- olink_qns %>% 
      filter(OlinkID %in% hits$OlinkID) %>%
      # sort by Pval
      mutate(Protein = factor(Assay, levels = hits$Assay)) %>% 
      drop_na(NPX, Protein, Smoking, all_of(ii)) %>% 
      ggplot() +
      aes_string(x = ii, y = "NPX") +
      facet_wrap(~ Protein, ncol = 3, scales = "free_y") +
      geom_boxplot() +
      add_n() +
      ggtitle(paste(ii, ":", codes$Label[codes$Variable == ii]))
    print(p)
  }
}
```

#### THI total score

- Linear regression for the association between one protein and **THI total score**, 
including age, smoking, and sample lab.

- `lm(Protein ~ (THI total score) + age + smoking + sample lab)`

- Due to missing information, `r nrow(drop_na(qns, Smoking, all_of("THI Total score")))` samples were analyzed here.

##### Numeric score

```{r, purl=TRUE}
# Association tests
out_df <- assoc_res$THI_total_score$num <- olink_qns %>%
  nest(data = -c(OlinkID, Assay)) %>%
  add_column(map_dfr(.$data, ~ lm_out_1line(
    # to avoid too large cache
    NPX ~ `THI Total score` + Age + Smoking + `Sample Lab`, .x
  ))) %>%
  select(-data) %>% 
  mutate(qval = qvalue::qvalue(Pval)$qvalues)
```

* `r Words(sum(out_df$qval < 0.05))` protein was significantly associated with THI total score as numeric (_q_ value < 0.05).

```{r}
out_df %>% 
  show_res_p(Protein = Assay, "Trend" = Estimate, "q value" = qval)
```

##### Ordinal categorical scores

```{r}
score_cut <- tribble(
  ~up_bound, ~lab,
   16,       "Negligible", 
   36,       "Light", 
   56,       "Moderate", 
   76,       "Severe", 
  100,       "Catastrophic"
)

# Explanation on the categorization
score_cut %>% 
  mutate(Range = paste(lag(up_bound, default = -1) + 1, "-", up_bound)) %>% 
  select(Label = lab, Range) %>% 
  kbl(align = "lc") %>% 
  kable_styling(full_width = FALSE)
```

```{r, purl=TRUE}
# Association tests
out_df <- assoc_res$THI_total_score$ord <- olink_qns %>% 
  mutate(
    # ordered categories
    THI.Total.score.cat = cut(
      `THI Total score`, 
      breaks = c(-1, score_cut$up_bound),
      labels = score_cut$lab,
      ordered_result = T
    )
  ) %>%
  nest(data = -c(OlinkID, Assay)) %>%
  add_column(map_dfr(.$data, ~ lm_out_1line(
    # to avoid too large cache
    NPX ~ THI.Total.score.cat + Age + Smoking + `Sample Lab`, .x
  ))) %>%
  select(-data) %>% 
  mutate(qval = qvalue::qvalue(Pval)$qvalues)
```

* `r Words(sum(out_df$qval < 0.05))` protein was significantly associated with THI total score as ordered categorical (_q_ value < 0.05).

```{r}
out_df %>% 
  show_res_p(Protein = Assay, "Trend" = Estimate, "q value" = qval)
```

------------------------

### Other selected variables

#### Statistical test models

- Linear regression model for the association between one protein and one of selected variables, including age, smoking, and sample lab.
If both cases and controls were included, tinnitus status was also included as an adjusting factor.

- `lm(Protein ~ (a variable) + age + smoking + sample lab + tinnitus)`

```{r, purl=TRUE}
others <- tribble(
  ~lab,      ~test,  ~desc,
  "Intro_8",  "lm", "Gross income",
  "Intro_9", "aov", "Education",
  "TSCHQ_28", "lm", "Tolerate loud sounds",
  "A15_4",    "lm", "Temporomandibular joint pain",
  "A12",      "lm", "Solely sensitive"
) %>% 
  mutate(
    # one line version of those tests
    f_1line = map(test, ~ get(paste0(.x, "_out_1line"))),
  )
# Association tests
assoc_res$others <- lapply(
  1:nrow(others),
  function(ii) {
    f <- formula(paste(
      "NPX ~", others$lab[ii], "+ Age + Smoking + `Sample Lab` + Tinnitus"
    ))
    no_na <- olink_qns %>%
      select(OlinkID, Assay, all_of(all.vars(f))) %>% 
      drop_na(all_of(all.vars(f)))
    
    if(n_distinct(no_na$Tinnitus) < 2) f <- update.formula(f, ~ . - Tinnitus)
    no_na %>% 
      nest(data = -c(OlinkID, Assay)) %>% 
      add_column(map_dfr(.$data, ~ others$f_1line[[ii]](f, .x))) %>%
      select(-data) %>% 
      mutate(qval = qvalue::qvalue(Pval)$qvalues)
  }
)
```

#### Results

```{r}
for(ii in 1:nrow(others)) {
  cat(
    "#####", others$desc[ii], ":", paste0("`", others$lab[ii], "`"), "\n",
    "* Question :", codes$Label[codes$Variable == others$lab[ii]], "\n",
    "*", Words(sum(assoc_res$others[[ii]]$qval < 0.05)), 
    "protein was significantly associated (_q_ value < 0.05).\n"
  )
  p <- if(others$test[ii] == "lm") {
    assoc_res$others[[ii]] %>% 
      show_res_p(Protein = Assay, Estimate, "_q_ value" = qval)
  } else {
    assoc_res$others[[ii]] %>% 
      show_res_p(Protein = Assay, "_q_ value" = qval)
  }
  print(p)
  cat("\n\n")
}
```

```{r, purl=TRUE, include=FALSE}
save(assoc_res, file = fn$o$res)
```

----------------------------

## Methods

_short text about the methods. Please rephrase for manuscripts_

Bioinformatic data handling and statistic analyses were conducted on `r R.version.string`, 
together with tidyverse (v. `r packageVersion("tidyverse")`) package. 
The association between a protein and a clinical trait was tested using linear regression or ANOVA including described covariates. 
Two methods were applied for multiple testing correction, Westfall and Young's max-T method 
[@westfall1993resampling] and _q_ value [@storey2003positive].
Resampling of the former method was conducted $`r N_PERMUTATION`$ times.
The 'q value' was computed using 'qvalue' (v `r packageVersion("qvalue")`) R package. 
Homoscedasticity assumption was checked by Bartlett's test.

### References
